import apache_log_parser 
import induce
import collections
import random
random.seed(0)


def test_apachelogparse1():
    log_lines = '''
127.0.0.1 <<6113>> [16/Aug/2013:15:45:34 +0000] 1966093us "GET / HTTP/1.1" 200 3478  "https://example.com/" "Mozilla/5.0 (X11; U; Linux x86_64; en-US; rv:1.9.2.18)" - -
'''[1:-1]
    grammar = '''
$START ::= $@.<LAMBDA>:MATCHED_STRINGS.REMOTE_HOST$@.ESCAPE:PATTERN$@.<LAMBDA>:MATCHED_STRINGS.PID$@.ESCAPE:PATTERN[16/Aug/$USERAGENTPARSER.V1_REPLACEMENT:15:45:34 +$FIXEDOFFSET._FIXEDOFFSET__NAME] $@.<LAMBDA>:MATCHED_STRINGS.TIME_US$@.ESCAPE:PATTERN$@.EXTRA_REQUEST_FROM_FIRST_LINE:FIRST_LINE$@.ESCAPE:PATTERN$@.<LAMBDA>:MATCHED_STRINGS.STATUS $@.<LAMBDA>:MATCHED_STRINGS.RESPONSE_BYTES_CLF$@.ESCAPE:PATTERN$@.<LAMBDA>:MATCHED_STRINGS.REQUEST_HEADER_REFERER$@.ESCAPE:PATTERN"$USERAGENTPARSER.PARSE:USER_AGENT_STRING$@.ESCAPE:PATTERN- -
$@.EXTRA_REQUEST_FROM_FIRST_LINE:FIRST_LINE ::= $@.MATCH:STRING
$USERAGENTPARSER.PARSE:USER_AGENT_STRING ::= $DEVICEPARSER.PARSE:USER_AGENT_STRING
$FIXEDOFFSET._FIXEDOFFSET__NAME ::= $FIXEDOFFSET.__INIT__:STRING
$USERAGENTPARSER.V1_REPLACEMENT ::= $OSPARSER.OS_V1_REPLACEMENT
$@.ESCAPE:PATTERN ::=   "
	|  <<
	| " 
	| >> 
	| us "
$@.<LAMBDA>:MATCHED_STRINGS.REQUEST_HEADER_REFERER ::= $PARSER.PARSE:RESULTS.REQUEST_HEADER_REFERER
$@.<LAMBDA>:MATCHED_STRINGS.RESPONSE_BYTES_CLF ::= $PARSER.PARSE:RESULTS.RESPONSE_BYTES_CLF
$@.<LAMBDA>:MATCHED_STRINGS.REMOTE_HOST ::= $PARSER.PARSE:RESULTS.REMOTE_HOST
$@.<LAMBDA>:MATCHED_STRINGS.TIME_US ::= $PARSER.PARSE:RESULTS.TIME_US
$@.<LAMBDA>:MATCHED_STRINGS.STATUS ::= $PARSER.PARSE:RESULTS.STATUS
$@.<LAMBDA>:MATCHED_STRINGS.PID ::= $PARSER.PARSE:RESULTS.PID
$DEVICEPARSER.PARSE:USER_AGENT_STRING ::= $USERAGENT.__INIT__:USER_AGENT_STRING
$FIXEDOFFSET.__INIT__:STRING ::= 0000
$OSPARSER.OS_V1_REPLACEMENT ::= 2013
$@.MATCH:STRING ::= $@.EXTRA_REQUEST_FROM_FIRST_LINE:MATCHED_STRINGS.REQUEST_FIRST_LINE
$PARSER.PARSE:RESULTS.REQUEST_HEADER_REFERER ::= $PARSER.PARSE:VALUES.REQUEST_HEADER_REFERER
$PARSER.PARSE:RESULTS.RESPONSE_BYTES_CLF ::= $PARSER.PARSE:VALUES.RESPONSE_BYTES_CLF
$PARSER.PARSE:RESULTS.REMOTE_HOST ::= $PARSER.PARSE:VALUES.REMOTE_HOST
$PARSER.PARSE:RESULTS.TIME_US ::= $PARSER.PARSE:VALUES.TIME_US
$PARSER.PARSE:RESULTS.STATUS ::= $PARSER.PARSE:VALUES.STATUS
$PARSER.PARSE:RESULTS.PID ::= $PARSER.PARSE:VALUES.PID
$USERAGENT.__INIT__:USER_AGENT_STRING ::= $@.PARSEUSERAGENT:USER_AGENT_STRING
$@.EXTRA_REQUEST_FROM_FIRST_LINE:MATCHED_STRINGS.REQUEST_FIRST_LINE ::= $@.EXTRA_REQUEST_FROM_FIRST_LINE:RESULTS.REQUEST_FIRST_LINE
$PARSER.PARSE:VALUES.REQUEST_HEADER_REFERER ::= $@.TEST_APACHELOGPARSE1:PARSER.PARSE_@.REQUEST_HEADER_REFERER
$PARSER.PARSE:VALUES.RESPONSE_BYTES_CLF ::= $@.TEST_APACHELOGPARSE1:PARSER.PARSE_@.RESPONSE_BYTES_CLF
$PARSER.PARSE:VALUES.REMOTE_HOST ::= $@.TEST_APACHELOGPARSE1:PARSER.PARSE_@.REMOTE_HOST
$PARSER.PARSE:VALUES.TIME_US ::= $@.TEST_APACHELOGPARSE1:PARSER.PARSE_@.TIME_US
$PARSER.PARSE:VALUES.STATUS ::= $@.TEST_APACHELOGPARSE1:PARSER.PARSE_@.STATUS
$PARSER.PARSE:VALUES.PID ::= $@.TEST_APACHELOGPARSE1:PARSER.PARSE_@.PID
$@.PARSEUSERAGENT:USER_AGENT_STRING ::= $OSPARSER.PARSE:USER_AGENT_STRING
$@.EXTRA_REQUEST_FROM_FIRST_LINE:RESULTS.REQUEST_FIRST_LINE ::= $@.EXTRA_REQUEST_FROM_FIRST_LINE:RESULTS.REQUEST_METHOD / HTTP/$@.EXTRA_REQUEST_FROM_FIRST_LINE:RESULTS.REQUEST_HTTP_VER
$@.TEST_APACHELOGPARSE1:PARSER.PARSE_@.REQUEST_HEADER_REFERER ::= $PARSER.PARSE:@.<LAMBDA>_@.REQUEST_HEADER_REFERER
$@.TEST_APACHELOGPARSE1:PARSER.PARSE_@.RESPONSE_BYTES_CLF ::= $PARSER.PARSE:@.<LAMBDA>_@.RESPONSE_BYTES_CLF
$@.TEST_APACHELOGPARSE1:PARSER.PARSE_@.REMOTE_HOST ::= $PARSER.PARSE:@.<LAMBDA>_@.REMOTE_HOST
$@.TEST_APACHELOGPARSE1:PARSER.PARSE_@.TIME_US ::= $PARSER.PARSE:@.<LAMBDA>_@.TIME_US
$@.TEST_APACHELOGPARSE1:PARSER.PARSE_@.STATUS ::= $PARSER.PARSE:@.<LAMBDA>_@.STATUS
$@.TEST_APACHELOGPARSE1:PARSER.PARSE_@.PID ::= $PARSER.PARSE:@.<LAMBDA>_@.PID
$OSPARSER.PARSE:USER_AGENT_STRING ::= $@.PARSEDEVICE:USER_AGENT_STRING
$@.EXTRA_REQUEST_FROM_FIRST_LINE:RESULTS.REQUEST_HTTP_VER ::= $PARSER.PARSE:RESULTS.REQUEST_HTTP_VER
$@.EXTRA_REQUEST_FROM_FIRST_LINE:RESULTS.REQUEST_METHOD ::= $PARSER.PARSE:RESULTS.REQUEST_METHOD
$PARSER.PARSE:@.<LAMBDA>_@.REQUEST_HEADER_REFERER ::= https://example.com/
$PARSER.PARSE:@.<LAMBDA>_@.RESPONSE_BYTES_CLF ::= 3478
$PARSER.PARSE:@.<LAMBDA>_@.REMOTE_HOST ::= 127.0.0.1
$PARSER.PARSE:@.<LAMBDA>_@.TIME_US ::= 1966093
$PARSER.PARSE:@.<LAMBDA>_@.STATUS ::= 200
$PARSER.PARSE:@.<LAMBDA>_@.PID ::= 6113
$@.PARSEDEVICE:USER_AGENT_STRING ::= Mozilla/5.0 (X11; U; $@.PARSE_OPERATING_SYSTEM:FAMILY x86_64; en-US; rv:1.9.2.18)
$PARSER.PARSE:RESULTS.REQUEST_HTTP_VER ::= $PARSER.PARSE:VALUES.REQUEST_HTTP_VER
$PARSER.PARSE:RESULTS.REQUEST_METHOD ::= $PARSER.PARSE:VALUES.REQUEST_METHOD
$@.PARSE_OPERATING_SYSTEM:FAMILY ::= $OPERATINGSYSTEM.__NEW__:FAMILY
$PARSER.PARSE:VALUES.REQUEST_HTTP_VER ::= $PARSER.PARSE:@.EXTRA_REQUEST_FROM_FIRST_LINE_@.REQUEST_HTTP_VER
$PARSER.PARSE:VALUES.REQUEST_METHOD ::= $PARSER.PARSE:@.EXTRA_REQUEST_FROM_FIRST_LINE_@.REQUEST_METHOD
$OPERATINGSYSTEM.__NEW__:FAMILY ::= $OSPARSER.PARSE:OS
$PARSER.PARSE:@.EXTRA_REQUEST_FROM_FIRST_LINE_@.REQUEST_HTTP_VER ::= $@.TEST_APACHELOGPARSE1:PARSER.PARSE_@.REQUEST_HTTP_VER
$PARSER.PARSE:@.EXTRA_REQUEST_FROM_FIRST_LINE_@.REQUEST_METHOD ::= $@.TEST_APACHELOGPARSE1:PARSER.PARSE_@.REQUEST_METHOD
$OSPARSER.PARSE:OS ::= $@.PARSEOS:OS
$@.TEST_APACHELOGPARSE1:PARSER.PARSE_@.REQUEST_HTTP_VER ::= 1.1
$@.TEST_APACHELOGPARSE1:PARSER.PARSE_@.REQUEST_METHOD ::= GET
$@.PARSEOS:OS ::= $PARSER.PARSE:RESULTS.REQUEST_HEADER_USER_AGENT__OS__FAMILY
$PARSER.PARSE:RESULTS.REQUEST_HEADER_USER_AGENT__OS__FAMILY ::= $PARSER.PARSE:VALUES.REQUEST_HEADER_USER_AGENT__OS__FAMILY
$PARSER.PARSE:VALUES.REQUEST_HEADER_USER_AGENT__OS__FAMILY ::= $@.TEST_APACHELOGPARSE1:PARSER.PARSE_@.REQUEST_HEADER_USER_AGENT__OS__FAMILY
$@.TEST_APACHELOGPARSE1:PARSER.PARSE_@.REQUEST_HEADER_USER_AGENT__OS__FAMILY ::= $PARSER.PARSE:@.PARSE_USER_AGENT_@.REQUEST_HEADER_USER_AGENT__OS__FAMILY
$PARSER.PARSE:@.PARSE_USER_AGENT_@.REQUEST_HEADER_USER_AGENT__OS__FAMILY ::= $USERAGENT.__INIT__:UA_DICT.OS.FAMILY
$USERAGENT.__INIT__:UA_DICT.OS.FAMILY ::= $@.PARSE:@.PARSEOS_@.FAMILY
$@.PARSE:@.PARSEOS_@.FAMILY ::= $@.PARSE:V.OS.FAMILY
$@.PARSE:V.OS.FAMILY ::= $USERAGENT.__INIT__:@.PARSE_@.OS.FAMILY
$USERAGENT.__INIT__:@.PARSE_@.OS.FAMILY ::= Linux
'''[1:-1]
    result = []
    for log in log_lines.split('\n'):
        if log.strip() == '': continue
        with induce.Tracer(log, result) as t:
            line_parser = apache_log_parser.make_parser("%h <<%P>> %t %Dus \"%r\" %>s %b  \"%{Referer}i\" \"%{User-Agent}i\" %l %u")
            log_line_data = line_parser(log)
    with induce.grammar() as g:
        for jframe in result:
                g.handle_events(jframe)
        print(str(g))
        assert(grammar == str(g))

def test_apachelogparse2():
    log_lines = '''
127.0.0.1 <<6113>> [16/Aug/2013:15:45:34 +0000] 1966093us "GET / HTTP/1.1" 200 3478  "https://example.com/" "Mozilla/5.0 (X11; U; Linux x86_64; en-US; rv:1.9.2.18)" - -
127.0.0.1 <<6113>> [16/Aug/2013:15:45:39 +0000] 1966093us "GET /test HTTP/1.0" 200 3000  "https://myexample.org/" "Mozilla/5.0 (X11; U; FreeBSD x86_64; en-UK; rv:1.9.2.18)" - -
10.1.1.1 <<6113>> [16/Aug/2013:15:35:39 +0000] 1966093us "GET /test1 HTTP/1.0" 200 3000  "https://newwebsite.org/" "Mozilla/5.0 (X11; U; FreeBSD x86_64; en-UK; rv:1.9.2.18)" - -
10.1.1.1 <<6113>> [16/Aug/2013:15:45:39 +0000] 1966093us "GET /test2 HTTP/1.1" 200 3000  "https://myexample.org/" "Mozilla/5.0 (X11; U; FreeBSD x86_64; en-UK; rv:1.9.2.18)" - -
'''[1:-1]
    grammar = '''
$START ::= $@.<LAMBDA>:MATCHED_STRINGS.REMOTE_HOST$@.ESCAPE:PATTERN$@.<LAMBDA>:MATCHED_STRINGS.PID$@.ESCAPE:PATTERN[16/Aug/$USERAGENTPARSER.V1_REPLACEMENT:15:45:39 +$FIXEDOFFSET._FIXEDOFFSET__NAME] $@.<LAMBDA>:MATCHED_STRINGS.TIME_US$@.ESCAPE:PATTERN$@.EXTRA_REQUEST_FROM_FIRST_LINE:FIRST_LINE$@.ESCAPE:PATTERN$@.<LAMBDA>:MATCHED_STRINGS.STATUS $@.<LAMBDA>:MATCHED_STRINGS.RESPONSE_BYTES_CLF$@.ESCAPE:PATTERN$@.<LAMBDA>:MATCHED_STRINGS.REQUEST_HEADER_REFERER$@.ESCAPE:PATTERN"$USERAGENTPARSER.PARSE:USER_AGENT_STRING$@.ESCAPE:PATTERN- -
	| $@.<LAMBDA>:MATCHED_STRINGS.REMOTE_HOST$@.ESCAPE:PATTERN$@.<LAMBDA>:MATCHED_STRINGS.PID$@.ESCAPE:PATTERN[16/Aug/2013:15:35:39 +$FIXEDOFFSET._FIXEDOFFSET__NAME] $@.<LAMBDA>:MATCHED_STRINGS.TIME_US$@.ESCAPE:PATTERN$@.EXTRA_REQUEST_FROM_FIRST_LINE:FIRST_LINE$@.ESCAPE:PATTERN$@.<LAMBDA>:MATCHED_STRINGS.STATUS $@.<LAMBDA>:MATCHED_STRINGS.RESPONSE_BYTES_CLF$@.ESCAPE:PATTERN$@.<LAMBDA>:MATCHED_STRINGS.REQUEST_HEADER_REFERER$@.ESCAPE:PATTERN"$USERAGENT.__INIT__:USER_AGENT_STRING$@.ESCAPE:PATTERN- -
	| $@.<LAMBDA>:MATCHED_STRINGS.REMOTE_HOST$@.ESCAPE:PATTERN$@.<LAMBDA>:MATCHED_STRINGS.PID$@.ESCAPE:PATTERN[16/Aug/2013:15:45:34 +$FIXEDOFFSET._FIXEDOFFSET__NAME] $@.<LAMBDA>:MATCHED_STRINGS.TIME_US$@.ESCAPE:PATTERN$@.EXTRA_REQUEST_FROM_FIRST_LINE:FIRST_LINE$@.ESCAPE:PATTERN$@.<LAMBDA>:MATCHED_STRINGS.STATUS $@.<LAMBDA>:MATCHED_STRINGS.RESPONSE_BYTES_CLF$@.ESCAPE:PATTERN$@.<LAMBDA>:MATCHED_STRINGS.REQUEST_HEADER_REFERER$@.ESCAPE:PATTERN"$USERAGENT.__INIT__:USER_AGENT_STRING$@.ESCAPE:PATTERN- -
	| 10.$@.EXTRA_REQUEST_FROM_FIRST_LINE:RESULTS.REQUEST_HTTP_VER.1$@.ESCAPE:PATTERN$@.<LAMBDA>:MATCHED_STRINGS.PID$@.ESCAPE:PATTERN[16/Aug/2013:15:45:39 +$FIXEDOFFSET._FIXEDOFFSET__NAME] $@.<LAMBDA>:MATCHED_STRINGS.TIME_US$@.ESCAPE:PATTERN$@.EXTRA_REQUEST_FROM_FIRST_LINE:FIRST_LINE$@.ESCAPE:PATTERN$@.<LAMBDA>:MATCHED_STRINGS.STATUS $@.<LAMBDA>:MATCHED_STRINGS.RESPONSE_BYTES_CLF$@.ESCAPE:PATTERN$@.<LAMBDA>:MATCHED_STRINGS.REQUEST_HEADER_REFERER$@.ESCAPE:PATTERN"$USERAGENT.__INIT__:USER_AGENT_STRING$@.ESCAPE:PATTERN- -
$@.EXTRA_REQUEST_FROM_FIRST_LINE:FIRST_LINE ::= $@.EXTRA_REQUEST_FROM_FIRST_LINE:RESULTS.REQUEST_METHOD $@.EXTRA_REQUEST_FROM_FIRST_LINE:URL HTTP/$@.EXTRA_REQUEST_FROM_FIRST_LINE:RESULTS.REQUEST_HTTP_VER
	| $@.EXTRA_REQUEST_FROM_FIRST_LINE:RESULTS.REQUEST_METHOD $@.EXTRA_REQUEST_FROM_FIRST_LINE:URL HTTP/$PARSER.PARSE:RESULTS.REQUEST_HTTP_VER
	| $@.MATCH:STRING
$USERAGENT.__INIT__:USER_AGENT_STRING ::= $@.PARSEUSERAGENT:USER_AGENT_STRING
	| Mozilla/5.0 (X11; U; $@.PARSE_OPERATING_SYSTEM:FAMILY x86_64; en-UK; rv:1.9.2.18)
	| Mozilla/5.0 (X11; U; $@.PARSE_OPERATING_SYSTEM:FAMILY x86_64; en-US; rv:1.9.2.18)
$FIXEDOFFSET._FIXEDOFFSET__NAME ::= $FIXEDOFFSET.__INIT__:STRING
$@.ESCAPE:PATTERN ::=   "
	|  <<
	| " 
	| >> 
	| us "
$@.<LAMBDA>:MATCHED_STRINGS.REQUEST_HEADER_REFERER ::= $PARSER.PARSE:RESULTS.REQUEST_HEADER_REFERER
$@.<LAMBDA>:MATCHED_STRINGS.RESPONSE_BYTES_CLF ::= $PARSER.PARSE:RESULTS.RESPONSE_BYTES_CLF
$@.<LAMBDA>:MATCHED_STRINGS.REMOTE_HOST ::= $PARSER.PARSE:RESULTS.REMOTE_HOST
$@.<LAMBDA>:MATCHED_STRINGS.TIME_US ::= $PARSER.PARSE:RESULTS.TIME_US
$@.<LAMBDA>:MATCHED_STRINGS.STATUS ::= $PARSER.PARSE:RESULTS.STATUS
$@.<LAMBDA>:MATCHED_STRINGS.PID ::= $PARSER.PARSE:RESULTS.PID
$@.PARSE_OPERATING_SYSTEM:FAMILY ::= $OPERATINGSYSTEM.__NEW__:FAMILY
$FIXEDOFFSET.__INIT__:STRING ::= 0000
$@.MATCH:STRING ::= $@.EXTRA_REQUEST_FROM_FIRST_LINE:MATCHED_STRINGS.REQUEST_FIRST_LINE
$PARSER.PARSE:RESULTS.REQUEST_HEADER_REFERER ::= $PARSER.PARSE:VALUES.REQUEST_HEADER_REFERER
$PARSER.PARSE:RESULTS.RESPONSE_BYTES_CLF ::= $PARSER.PARSE:VALUES.RESPONSE_BYTES_CLF
$PARSER.PARSE:RESULTS.REMOTE_HOST ::= $PARSER.PARSE:VALUES.REMOTE_HOST
$PARSER.PARSE:RESULTS.TIME_US ::= $PARSER.PARSE:VALUES.TIME_US
$PARSER.PARSE:RESULTS.STATUS ::= $PARSER.PARSE:VALUES.STATUS
$PARSER.PARSE:RESULTS.PID ::= $PARSER.PARSE:VALUES.PID
$OPERATINGSYSTEM.__NEW__:FAMILY ::= $OSPARSER.PARSE:OS
	| $PARSER.PARSE:RESULTS.REQUEST_HEADER_USER_AGENT__OS__FAMILY
$@.EXTRA_REQUEST_FROM_FIRST_LINE:MATCHED_STRINGS.REQUEST_FIRST_LINE ::= $@.EXTRA_REQUEST_FROM_FIRST_LINE:RESULTS.REQUEST_FIRST_LINE
$PARSER.PARSE:VALUES.REQUEST_HEADER_REFERER ::= $@.TEST_APACHELOGPARSE2:PARSER.PARSE_@.REQUEST_HEADER_REFERER
$PARSER.PARSE:VALUES.RESPONSE_BYTES_CLF ::= $@.TEST_APACHELOGPARSE2:PARSER.PARSE_@.RESPONSE_BYTES_CLF
$PARSER.PARSE:VALUES.REMOTE_HOST ::= $@.TEST_APACHELOGPARSE2:PARSER.PARSE_@.REMOTE_HOST
$PARSER.PARSE:VALUES.TIME_US ::= $@.TEST_APACHELOGPARSE2:PARSER.PARSE_@.TIME_US
$PARSER.PARSE:VALUES.STATUS ::= $@.TEST_APACHELOGPARSE2:PARSER.PARSE_@.STATUS
$PARSER.PARSE:VALUES.PID ::= $@.TEST_APACHELOGPARSE2:PARSER.PARSE_@.PID
$@.EXTRA_REQUEST_FROM_FIRST_LINE:RESULTS.REQUEST_FIRST_LINE ::= $@.EXTRA_REQUEST_FROM_FIRST_LINE:RESULTS.REQUEST_METHOD / HTTP/$@.EXTRA_REQUEST_FROM_FIRST_LINE:RESULTS.REQUEST_HTTP_VER
$PARSER.PARSE:RESULTS.REQUEST_HEADER_USER_AGENT__OS__FAMILY ::= $PARSER.PARSE:VALUES.REQUEST_HEADER_USER_AGENT__OS__FAMILY
$@.TEST_APACHELOGPARSE2:PARSER.PARSE_@.REQUEST_HEADER_REFERER ::= $PARSER.PARSE:@.<LAMBDA>_@.REQUEST_HEADER_REFERER
$@.TEST_APACHELOGPARSE2:PARSER.PARSE_@.RESPONSE_BYTES_CLF ::= $PARSER.PARSE:@.<LAMBDA>_@.RESPONSE_BYTES_CLF
$@.TEST_APACHELOGPARSE2:PARSER.PARSE_@.REMOTE_HOST ::= $PARSER.PARSE:@.<LAMBDA>_@.REMOTE_HOST
$@.TEST_APACHELOGPARSE2:PARSER.PARSE_@.TIME_US ::= $PARSER.PARSE:@.<LAMBDA>_@.TIME_US
$@.TEST_APACHELOGPARSE2:PARSER.PARSE_@.STATUS ::= $PARSER.PARSE:@.<LAMBDA>_@.STATUS
$@.TEST_APACHELOGPARSE2:PARSER.PARSE_@.PID ::= $PARSER.PARSE:@.<LAMBDA>_@.PID
$PARSER.PARSE:VALUES.REQUEST_HEADER_USER_AGENT__OS__FAMILY ::= $@.TEST_APACHELOGPARSE2:PARSER.PARSE_@.REQUEST_HEADER_USER_AGENT__OS__FAMILY
$@.EXTRA_REQUEST_FROM_FIRST_LINE:RESULTS.REQUEST_HTTP_VER ::= $PARSER.PARSE:RESULTS.REQUEST_HTTP_VER
$@.EXTRA_REQUEST_FROM_FIRST_LINE:RESULTS.REQUEST_METHOD ::= $PARSER.PARSE:RESULTS.REQUEST_METHOD
$PARSER.PARSE:@.<LAMBDA>_@.REQUEST_HEADER_REFERER ::= https://example.com/
	| https://myexample.org/
	| https://newwebsite.org/
$PARSER.PARSE:@.<LAMBDA>_@.RESPONSE_BYTES_CLF ::= 3000
	| 3478
$PARSER.PARSE:@.<LAMBDA>_@.REMOTE_HOST ::= 10.1.1.1
	| 127.0.0.1
$PARSER.PARSE:@.<LAMBDA>_@.TIME_US ::= 1966093
$PARSER.PARSE:@.<LAMBDA>_@.STATUS ::= 200
$PARSER.PARSE:@.<LAMBDA>_@.PID ::= 6113
$PARSER.PARSE:RESULTS.REQUEST_HTTP_VER ::= $PARSER.PARSE:VALUES.REQUEST_HTTP_VER
$PARSER.PARSE:RESULTS.REQUEST_METHOD ::= $PARSER.PARSE:VALUES.REQUEST_METHOD
$@.TEST_APACHELOGPARSE2:PARSER.PARSE_@.REQUEST_HEADER_USER_AGENT__OS__FAMILY ::= $PARSER.PARSE:@.PARSE_USER_AGENT_@.REQUEST_HEADER_USER_AGENT__OS__FAMILY
$PARSER.PARSE:VALUES.REQUEST_HTTP_VER ::= $PARSER.PARSE:@.EXTRA_REQUEST_FROM_FIRST_LINE_@.REQUEST_HTTP_VER
$PARSER.PARSE:VALUES.REQUEST_METHOD ::= $PARSER.PARSE:@.EXTRA_REQUEST_FROM_FIRST_LINE_@.REQUEST_METHOD
$PARSER.PARSE:@.PARSE_USER_AGENT_@.REQUEST_HEADER_USER_AGENT__OS__FAMILY ::= $USERAGENT.__INIT__:UA_DICT.OS.FAMILY
$PARSER.PARSE:@.EXTRA_REQUEST_FROM_FIRST_LINE_@.REQUEST_HTTP_VER ::= $@.TEST_APACHELOGPARSE2:PARSER.PARSE_@.REQUEST_HTTP_VER
$PARSER.PARSE:@.EXTRA_REQUEST_FROM_FIRST_LINE_@.REQUEST_METHOD ::= $@.TEST_APACHELOGPARSE2:PARSER.PARSE_@.REQUEST_METHOD
$USERAGENT.__INIT__:UA_DICT.OS.FAMILY ::= $@.PARSE:@.PARSEOS_@.FAMILY
	| $@.PARSE:CACHED.OS.FAMILY
$@.TEST_APACHELOGPARSE2:PARSER.PARSE_@.REQUEST_HTTP_VER ::= 1.0
	| 1.1
$@.TEST_APACHELOGPARSE2:PARSER.PARSE_@.REQUEST_METHOD ::= GET
$@.PARSE:CACHED.OS.FAMILY ::= $USERAGENT.__INIT__:@.PARSE_@.OS.FAMILY
$USERAGENT.__INIT__:@.PARSE_@.OS.FAMILY ::= FreeBSD
	| Linux
$USERAGENTPARSER.PARSE:USER_AGENT_STRING ::= $DEVICEPARSER.PARSE:USER_AGENT_STRING
$USERAGENTPARSER.V1_REPLACEMENT ::= $OSPARSER.OS_V1_REPLACEMENT
$DEVICEPARSER.PARSE:USER_AGENT_STRING ::= $USERAGENT.__INIT__:USER_AGENT_STRING
$@.EXTRA_REQUEST_FROM_FIRST_LINE:URL ::= $PARSERESULT.__NEW__:PATH
$OSPARSER.OS_V1_REPLACEMENT ::= 2013
$PARSERESULT.__NEW__:PATH ::= $SPLITRESULT.__NEW__:PATH
$@.PARSEUSERAGENT:USER_AGENT_STRING ::= $OSPARSER.PARSE:USER_AGENT_STRING
$SPLITRESULT.__NEW__:PATH ::= $@.URLPARSE:URL
$OSPARSER.PARSE:USER_AGENT_STRING ::= $@.PARSEDEVICE:USER_AGENT_STRING
$@.URLPARSE:URL ::= $@.URLSPLIT:URL
$@.PARSEDEVICE:USER_AGENT_STRING ::= Mozilla/5.0 (X11; U; $@.PARSE_OPERATING_SYSTEM:FAMILY x86_64; en-UK; rv:1.9.2.18)
$@.URLSPLIT:URL ::= $@.EXTRA_REQUEST_FROM_FIRST_LINE:RESULTS.REQUEST_URL_PATH
$@.EXTRA_REQUEST_FROM_FIRST_LINE:RESULTS.REQUEST_URL_PATH ::= $@.EXTRA_REQUEST_FROM_FIRST_LINE:RESULTS.REQUEST_URL
$@.EXTRA_REQUEST_FROM_FIRST_LINE:RESULTS.REQUEST_URL ::= $PARSER.PARSE:RESULTS.REQUEST_URL_PATH
$OSPARSER.PARSE:OS ::= $@.PARSEOS:OS
$PARSER.PARSE:RESULTS.REQUEST_URL_PATH ::= $PARSER.PARSE:VALUES.REQUEST_URL_PATH
$@.PARSEOS:OS ::= $PARSER.PARSE:RESULTS.REQUEST_HEADER_USER_AGENT__OS__FAMILY
$PARSER.PARSE:VALUES.REQUEST_URL_PATH ::= $PARSER.PARSE:RESULTS.REQUEST_URL
$PARSER.PARSE:RESULTS.REQUEST_URL ::= $PARSER.PARSE:VALUES.REQUEST_URL
$PARSER.PARSE:VALUES.REQUEST_URL ::= $PARSER.PARSE:@.EXTRA_REQUEST_FROM_FIRST_LINE_@.REQUEST_URL_PATH
$PARSER.PARSE:@.EXTRA_REQUEST_FROM_FIRST_LINE_@.REQUEST_URL_PATH ::= $PARSER.PARSE:@.EXTRA_REQUEST_FROM_FIRST_LINE_@.REQUEST_URL
$PARSER.PARSE:@.EXTRA_REQUEST_FROM_FIRST_LINE_@.REQUEST_URL ::= $@.TEST_APACHELOGPARSE2:PARSER.PARSE_@.REQUEST_URL_PATH
$@.TEST_APACHELOGPARSE2:PARSER.PARSE_@.REQUEST_URL_PATH ::= $@.TEST_APACHELOGPARSE2:PARSER.PARSE_@.REQUEST_URL
$@.TEST_APACHELOGPARSE2:PARSER.PARSE_@.REQUEST_URL ::= /test
	| /test1
	| /test2
$@.PARSE:@.PARSEOS_@.FAMILY ::= $@.PARSE:V.OS.FAMILY
$@.PARSE:V.OS.FAMILY ::= $USERAGENT.__INIT__:@.PARSE_@.OS.FAMILY
'''[1:-1]
    result = []
    for log in log_lines.split('\n'):
        if log.strip() == '': continue
        with induce.Tracer(log, result) as t:
            line_parser = apache_log_parser.make_parser("%h <<%P>> %t %Dus \"%r\" %>s %b  \"%{Referer}i\" \"%{User-Agent}i\" %l %u")
            log_line_data = line_parser(log)
    with induce.grammar() as g:
        for jframe in result:
            g.handle_events(jframe)
        print(str(g))
        assert(grammar == str(g))

